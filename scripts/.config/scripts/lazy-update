#!/bin/bash
# lazy-update â€” headless LazyVim plugin sync
# Exit codes: 0 success, 2 nvim not found

set -euo pipefail

LOG_DIR="$HOME/.local/state"
LOG_FILE="$LOG_DIR/lazy-update.log"
mkdir -p "$LOG_DIR"

# Detect Homebrew prefix (Apple Silicon vs Intel)
if [[ -d /opt/homebrew ]]; then
    BREW_PREFIX=/opt/homebrew
else
    BREW_PREFIX=/usr/local
fi
export PATH="$BREW_PREFIX/bin:$PATH"

timestamp() { date '+%Y-%m-%d %H:%M:%S'; }

log() { printf '[%s] %s\n' "$(timestamp)" "$*" | tee -a "$LOG_FILE"; }

# Check nvim exists
if ! command -v nvim &>/dev/null; then
    log "ERROR: nvim not found in PATH"
    exit 2
fi

log "Starting Lazy sync..."
if output=$(nvim --headless "+Lazy! sync" +qa 2>&1); then
    log "Lazy sync completed successfully"
else
    log "Lazy sync exited with status $?"
fi

if [[ -n "${output:-}" ]]; then
    printf '%s\n' "$output" >> "$LOG_FILE"
fi
